# ITI Attendance V2.0

تطبيق ويب لإدارة بيانات الموارد البشرية والحضور مبني على **Java 17 / Spring Boot 3** مع **Thymeleaf**. يدعم الأدوار الإدارية والموظفين والمديرين، ويغطي طلبات الإجازات والمأموريات والتصاريح وقواعد الحضور مع معالج إعداد مرئي لإعداد المؤسسة من الصفر.

## نظرة تقنية سريعة
- Spring Boot + Spring MVC + Spring Security مع مصادقة تعتمد على الموظفين وأدوارهم.
- Spring Data JPA مع MySQL (`ddl-auto=update`).
- تحميل ملفات (شعارات، صور شخصية وبطاقة رقم قومي) عبر خدمة تخزين الملفات المدمجة.
- واجهات عربية موحّدة تحتوي على شريط علوي يعرض شعار المؤسسة، الاسم، وصورة/اسم الموظف أو عنصر افتراضي عند عدم تسجيل الدخول.

## النماذج والخدمات الرئيسية
- **Organization / Branch / Department / JobTitle**: هيكل المؤسسة مع ربط الفروع والأقسام والمسميات الوظيفية.
- **Employee**: يدعم الأدوار (HR_MANAGER, HR_EMPLOYEE, MANAGER, BRANCH_MANAGER, TRAINING_MANAGER, EMPLOYEE) وحقل حالة (PENDING/ACTIVE) وصور شخصية ورقم قومي؛ البريد الإلكتروني فريد إجباريًا ويتم تطبيعه قبل الحفظ والاستيراد.
- **AttendanceRule & AttendanceRecord & AttendanceLimit**: قواعد الحضور لكل مؤسسة/فرع/قسم (مواعيد دخول/خروج + دقائق سماح) وسجل حضور وحد نسبة تنبيه للمديرين.
- **LeaveType**: يحدد قواعد الطلب لكل نوع (إجازة، مأمورية، تصريح) بما في ذلك ساعات السماح لتقديم الطلب (`graceHours`) ومتطلبات اعتماد المدير/الموارد البشرية.
- **LeaveRequest**: يخزن طلبات الإجازة/المأمورية/التصريح مع نوع الطلب (`RequestType`) وحالة الاعتماد.
- **ApprovalLevel**: سلسلة الاعتمادات حسب نوع الطلب والدور (أولوية `levelOrder`).
- **AccessPolicy**: يحدد الصفحات المسموح بها لكل دور مع دعم اختيار عدة صفحات في خطوة الإعداد.
- **FileStorageService**: تخزين مسارات الشعارات والصور الشخصية/الهوية وإعادة استخدامها في الواجهات.

## الصفحات والمسارات الأبرز
جميع الصفحات تشترك في ترويسة موحّدة وشريط جانبي للخدمات. المسارات الإدارية تبدأ بـ `/admin` بينما يمتلك الموظفون مسارات `/employee`، إضافة إلى صفحات التسجيل وتسجيل الدخول:

- تسجيل الموظفين/المديرين: `/register`، تسجيل الدخول العام: `/login`، تسجيل دخول الإدارة: `/admin/login`.
- المؤسسة والفروع والأقسام والمسميات: `/admin/organizations`, `/admin/branches`, `/admin/departments`, `/admin/job-titles` مع استيراد جماعي من Excel وقوالب قابلة للتنزيل.
- الموظفون: `/admin/employees` (إنشاء/تعديل/استيراد)، مع حفظ الصور الشخصية والهوية الوطنية ومتطلبات البريد الفريد.
- قواعد الحضور والسجلات وحد التنبيه: `/admin/rules`, `/admin/attendance`, `/admin/attendance-limit`.
- الأنواع والطلبات: `/admin/leave-types`, `/admin/leaves`, `/admin/missions`, `/admin/permits` (تشترك في نفس نموذج الطلب مع اختلاف نوع `RequestType`).
- الاعتمادات وسياسات الوصول: `/admin/approvals`, `/admin/access-policies` مع اختيار صفحات متعددة لكل دور.
- بوابة الموظف والمدير: `/employee/portal`, `/manager/dashboard` مع عرض الحضور والتنبيهات والطلبات بحسب الدور.

## معالج الإعداد `/setup`
تم تصميم معالج من سبع خطوات لتأسيس النظام بسرعة. كل خطوة تعرض تقدمًا وإمكانية الحفظ اليدوي أو الاستيراد الجماعي عند الحاجة:

1. **بيانات المؤسسة**: إدخال اسم ووصف المؤسسة مع رفع شعار (يُعاد استخدامه في الشريط العلوي). حفظ الشعار يتم عبر `FileStorageService` ويُحتفظ بالمسار عند التعديل.
2. **الفروع**: إضافة الفروع المرتبطة بالمؤسسة أو استيرادها دفعة واحدة (Excel)، مع جدول بالفروع الحالية.
3. **الأقسام**: ربط الأقسام بالفروع الموجودة مع دعم الاستيراد الجماعي.
4. **المسميات الوظيفية**: إنشاء المسميات أو استيرادها؛ تستخدم لاحقًا في تعريف الموظفين وموظفي الموارد البشرية.
5. **السياسات**: ضبط مستويات الاعتماد (نوع الطلب، ترتيب المستوى، الدور)، إعداد سياسات الوصول مع اختيار عدة صفحات مسموحة لكل دور، وتحديد حد الحضور (`AttendanceLimit`) الذي يحكم تنبيهات لوحة المدير. جميع النماذج تدعم الاستيراد الجماعي لبيانات الاعتماد أو السياسات.
6. **القواعد**: إنشاء أنواع الطلبات (إجازة/مأمورية/تصريح) مع الحد الأقصى لكل طلب ومتطلبات الاعتماد وساعات السماح لتقديم الطلب المتأخر، بالإضافة إلى قواعد الحضور (مواعيد دخول/خروج وسماح الدقائق) على مستوى المؤسسة/الفرع/القسم، وكلاهما يدعم الاستيراد من Excel.
7. **فريق الموارد البشرية**: إضافة موظفي HR (مع تشفير كلمة المرور وتعيين الفرع/القسم/المسمى) أو استيرادهم دفعة واحدة. تُحفظ الحالة نشطة افتراضيًا، ويتم فرض فريدة البريد الإلكتروني أثناء الحفظ والاستيراد.

كل خطوة تتحقق من اكتمال الخطوة السابقة قبل المتابعة، مع روابط رجوع/تقدم واضحة لإبقاء التسلسل منطقيًا من المؤسسة حتى الموارد البشرية.

## تشغيل المشروع محليًا
1. فعّل MySQL وحدّث بيانات الاتصال في `src/main/resources/application.properties`.
2. من جذر المشروع:
   ```bash
   mvn spring-boot:run
   ```
3. افتح `http://localhost:8080`.

### تفعيل أول مستخدم موارد بشرية
1. سجّل مستخدمًا من `/register` بدور HR_MANAGER أو HR_EMPLOYEE.
2. فعّل الحساب في قاعدة البيانات بتعديل الحالة إلى `ACTIVE`.
3. سجّل الدخول من `/login`، ثم أكمل معالج الإعداد لتجهيز المؤسسة والفروع والسياسات.
4. بعد الإعداد، استخدم `/admin/access-policies` لضبط الصفحات المسموح بها لكل دور، و `/admin/attendance-limit` لضبط الحد الأدنى للحضور.

## ملاحظات استخدام
- جميع العمليات الإدارية تستخدم حذفًا ناعمًا (`deleted`)، ويمكن استيراد البيانات من قوالب Excel من كل صفحة إدارة.
- البريد الإلكتروني للموظف إلزامي وفريد؛ ستظهر رسالة واضحة عند محاولة إدخال بريد مكرر.
- الطلبات (إجازة/مأمورية/تصريح) تحترم **ساعات السماح** المحددة في نوع الطلب؛ يتم منع الحفظ إذا تجاوز تاريخ الطلب فترة السماح.
- الواجهات تدعم عرض صورة الموظف الشخصية ووثيقة الهوية الوطنية عبر المسارات المخزّنة في خدمة الملفات، مع عناصر افتراضية عند غياب الملفات أو المستخدم.
